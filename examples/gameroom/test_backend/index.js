const sjcl = require("sjcl");
const fs = require('fs');
const crypto = require('crypto');
import { calculateGameAddress } from "./utils/addressing.js";
import { createTransaction, createBatch } from "./utils/transactions.js";
const MESSAGE_PREFIX = "b01374";
import { signPayload } from "./utils/crypto.js";
var XMLHttpRequest = require("xmlhttprequest").XMLHttpRequest;

function hashSHA256(salt, data) {
    const out = sjcl.hash.sha256.hash(salt + data);
    return sjcl.codec.hex.fromBits(out);
}

function encrypt(password, privateKey) {
    return JSON.stringify(sjcl.encrypt(password, privateKey));
}

// console.log(hashSHA256("alice@cargill.com", "password"))
// console.log(toHex(encrypt("password", "9966b755baccc25e9d8bd9e8cd8a19fcf67953b2636d101e52f4a40473bb1ea7")))
// console.log(toHex("{\"iv\":\"y2Y+9CajZsnl0wyVT03OIg==\",\"v\":1,\"iter\":10000,\"ks\":128,\"ts\":64,\"mode\":\"ccm\",\"adata\":\"\",\"cipher\":\"aes\",\"salt\":\"o+C1NA76cIA=\",\"ct\":\"F51lsPG01gP3Hojo4UWHX8qZd/6t1uJer3FIhrOCMrqoQFsMT2G7l4sHi/vm6BPzqQgo/xx99xXDAL5oXs/j8C1ZEtePkltU\"}"))

// console.log("bob")
// console.log(hashSHA256("bob@cargill.com", "password"))
// console.log(toHex(encrypt("password", "c1e325f8508ee82f6d8c15649a8335549057523575b8cc603bd3f471645c2fad")))
// console.log(toHex("{\"iv\":\"y2Y+9CajZsnl0wyVT03OIg==\",\"v\":1,\"iter\":10000,\"ks\":128,\"ts\":64,\"mode\":\"ccm\",\"adata\":\"\",\"cipher\":\"aes\",\"salt\":\"o+C1NA76cIA=\",\"ct\":\"F51lsPG01gP3Hojo4UWHX8qZd/6t1uJer3FIhrOCMrqoQFsMT2G7l4sHi/vm6BPzqQgo/xx99xXDAL5oXs/j8C1ZEtePkltU\"}"))


const alice = {
  "email": "alice@cargill.com",
  "hashedPassword": "a12f5170c30d6d9504e6d1fc64f33b472cb8c69e904b66cb421889a8ff263ade",
  "publicKey": "02685c1048fed717877ac4b9cf90f724c69a770d3c33a54e2e2483cb39beca8e2c",
  "privateKey": "c1e325f8508ee82f6d8c15649a8335549057523575b8cc603bd3f471645c2fad"
};
const bob = {
  "email": "bob@cargill.com",
  "hashedPassword": "4b6c8f7a8de9776aeb93e0bf4abf81666864b5b06cdb503b35383b0d02f30af0",
  "publicKey": "0317bd9b540436804fe8c2d0874188c708d9bc3909a03614e9b7b7a8c318de026e",
  "privateKey": "9966b755baccc25e9d8bd9e8cd8a19fcf67953b2636d101e52f4a40473bb1ea7"
};

async function http(
  method,
  url,
  data,
  headerFn,
  port
) {
  return new Promise((resolve, reject) => {
    const request = new XMLHttpRequest();
    request.open(method, `http://localhost:8000${url}`);
    if (headerFn) {
      headerFn(request);
    }
    request.onload = () => {
      if (request.status >= 200 && request.status < 300) {
        resolve(request.response);
      } else {
        const responseBody = JSON.parse(request.responseText);
        console.error(responseBody.message);
        if (request.status >= 400 && request.status < 500) {
          reject('Failed to send request. Contact the administrator for help.');
        } else {
          reject('The Gameroom server has encountered an error. Please contact the administrator.');
        }
      }
    };
    request.onerror = () => {
      console.error(request);
      reject('The Gameroom server has encountered an error. Please contact the administrator.');
    };
    request.send(data);
  });
}

async function submitBatch(payload, circuitID, port) {
  return await http(
    'POST', `/gamerooms/${circuitID}/batches`, payload, (request) => {
      request.setRequestHeader('Content-Type', 'application/octet-stream');
  }).catch((err) => {
    console.log("gi")
    console.log(err);
  }).then((rawBody) => {
    console.log("done");
    console.log(rawBody);
    // const jsonBody = JSON.parse(rawBody);
    // console.log(jsonBody.data);
    // return jsonBody.data;
  }, port);
}

function toHex(str) {
    var result = '';
    for (var i=0; i<str.length; i++) {
      result += str.charCodeAt(i).toString(16);
    }
    return result;
}

function createGame(user, gameName) {
    const payload = new Buffer(`${gameName},create,hello friend`, 'utf-8');
    const gameAdress = calculateGameAddress(gameName).slice(0, 6);
    const transaction = createTransaction(payload, [gameAdress], [gameAdress], user);
    return createBatch([transaction], user);
}

async function submitPayload(payload, port) {
  await http('POST', '/submit', payload, (request) => {
    request.setRequestHeader('Content-Type', 'application/octet-stream');
  }).catch((err) => {
    console.log(err)
  }, port)
}

const payload_bytes =  [
  10,
  83,
  8,
  2,
  26,
  64,
  153,
  59,
  192,
  189,
  62,
  220,
  88,
  2,
  194,
  164,
  96,
  89,
  176,
  209,
  200,
  129,
  224,
  31,
  210,
  87,
  152,
  138,
  190,
  127,
  204,
  153,
  151,
  5,
  152,
  238,
  70,
  139,
  215,
  24,
  33,
  13,
  114,
  72,
  15,
  218,
  166,
  220,
  85,
  137,
  254,
  16,
  66,
  195,
  0,
  82,
  147,
  227,
  173,
  219,
  112,
  180,
  9,
  98,
  100,
  189,
  134,
  43,
  185,
  207,
  34,
  13,
  97,
  99,
  109,
  101,
  45,
  110,
  111,
  100,
  101,
  45,
  48,
  48,
  48,
  34,
  181,
  4,
  10,
  178,
  4,
  10,
  11,
  81,
  49,
  99,
  51,
  109,
  45,
  112,
  85,
  55,
  79,
  65,
  18,
  144,
  1,
  10,
  4,
  97,
  48,
  48,
  48,
  18,
  8,
  115,
  99,
  97,
  98,
  98,
  97,
  114,
  100,
  26,
  13,
  97,
  99,
  109,
  101,
  45,
  110,
  111,
  100,
  101,
  45,
  48,
  48,
  48,
  34,
  25,
  10,
  13,
  112,
  101,
  101,
  114,
  95,
  115,
  101,
  114,
  118,
  105,
  99,
  101,
  115,
  18,
  8,
  91,
  34,
  97,
  48,
  48,
  49,
  34,
  93,
  34,
  84,
  10,
  10,
  97,
  100,
  109,
  105,
  110,
  95,
  107,
  101,
  121,
  115,
  18,
  70,
  91,
  34,
  48,
  50,
  100,
  100,
  99,
  98,
  49,
  57,
  50,
  101,
  56,
  55,
  50,
  52,
  100,
  53,
  48,
  56,
  57,
  100,
  97,
  98,
  50,
  55,
  53,
  101,
  97,
  98,
  53,
  52,
  100,
  50,
  97,
  51,
  57,
  52,
  52,
  51,
  49,
  101,
  99,
  100,
  49,
  54,
  49,
  55,
  102,
  100,
  51,
  55,
  54,
  48,
  51,
  57,
  98,
  57,
  98,
  53,
  56,
  52,
  52,
  49,
  49,
  48,
  56,
  100,
  34,
  93,
  18,
  145,
  1,
  10,
  4,
  97,
  48,
  48,
  49,
  18,
  8,
  115,
  99,
  97,
  98,
  98,
  97,
  114,
  100,
  26,
  14,
  98,
  117,
  98,
  98,
  97,
  45,
  110,
  111,
  100,
  101,
  45,
  48,
  48,
  48,
  34,
  25,
  10,
  13,
  112,
  101,
  101,
  114,
  95,
  115,
  101,
  114,
  118,
  105,
  99,
  101,
  115,
  18,
  8,
  91,
  34,
  97,
  48,
  48,
  48,
  34,
  93,
  34,
  84,
  10,
  10,
  97,
  100,
  109,
  105,
  110,
  95,
  107,
  101,
  121,
  115,
  18,
  70,
  91,
  34,
  48,
  50,
  100,
  100,
  99,
  98,
  49,
  57,
  50,
  101,
  56,
  55,
  50,
  52,
  100,
  53,
  48,
  56,
  57,
  100,
  97,
  98,
  50,
  55,
  53,
  101,
  97,
  98,
  53,
  52,
  100,
  50,
  97,
  51,
  57,
  52,
  52,
  51,
  49,
  101,
  99,
  100,
  49,
  54,
  49,
  55,
  102,
  100,
  51,
  55,
  54,
  48,
  51,
  57,
  98,
  57,
  98,
  53,
  56,
  52,
  52,
  49,
  49,
  48,
  56,
  100,
  34,
  93,
  26,
  50,
  10,
  14,
  98,
  117,
  98,
  98,
  97,
  45,
  110,
  111,
  100,
  101,
  45,
  48,
  48,
  48,
  18,
  32,
  116,
  99,
  112,
  115,
  58,
  47,
  47,
  115,
  112,
  108,
  105,
  110,
  116,
  101,
  114,
  100,
  45,
  110,
  111,
  100,
  101,
  45,
  98,
  117,
  98,
  98,
  97,
  58,
  56,
  48,
  52,
  52,
  26,
  48,
  10,
  13,
  97,
  99,
  109,
  101,
  45,
  110,
  111,
  100,
  101,
  45,
  48,
  48,
  48,
  18,
  31,
  116,
  99,
  112,
  115,
  58,
  47,
  47,
  115,
  112,
  108,
  105,
  110,
  116,
  101,
  114,
  100,
  45,
  110,
  111,
  100,
  101,
  45,
  97,
  99,
  109,
  101,
  58,
  56,
  48,
  52,
  52,
  32,
  1,
  40,
  1,
  48,
  1,
  56,
  1,
  66,
  8,
  103,
  97,
  109,
  101,
  114,
  111,
  111,
  109,
  74,
  131,
  1,
  123,
  34,
  115,
  99,
  97,
  98,
  98,
  97,
  114,
  100,
  95,
  97,
  100,
  109,
  105,
  110,
  95,
  107,
  101,
  121,
  115,
  34,
  58,
  91,
  34,
  48,
  50,
  100,
  100,
  99,
  98,
  49,
  57,
  50,
  101,
  56,
  55,
  50,
  52,
  100,
  53,
  48,
  56,
  57,
  100,
  97,
  98,
  50,
  55,
  53,
  101,
  97,
  98,
  53,
  52,
  100,
  50,
  97,
  51,
  57,
  52,
  52,
  51,
  49,
  101,
  99,
  100,
  49,
  54,
  49,
  55,
  102,
  100,
  51,
  55,
  54,
  48,
  51,
  57,
  98,
  57,
  98,
  53,
  56,
  52,
  52,
  49,
  49,
  48,
  56,
  100,
  34,
  93,
  44,
  34,
  97,
  108,
  105,
  97,
  115,
  34,
  58,
  34,
  102,
  102,
  114,
  114,
  102,
  102,
  118,
  102,
  103,
  118,
  114,
  103,
  103,
  114,
  103,
  114,
  99,
  102,
  32,
  102,
  103,
  118,
  32,
  114,
  102,
  114,
  34,
  125
];

submitPayload(signPayload(payload_bytes, alice.privateKey)).then((data) => console.log("fa"))

// fs.writeFile('../../../payload', createGame(alice, "name23"));//, "cGHwW-HydnS")

// console.log(Buffer.from(sdb).toString())
// console.log(createGame(alice, "first"))
// console.log(createGame(alice, "first").toString('binary'));

// submitBatch(createGame(alice, "first"), "vfp3v-R84nm").catch(err => console.log(err)).then(data => console.log(data));